<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>운동 기록</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; margin-bottom: 20px; }
        .back-btn { text-decoration: none; font-size: 18px; color: #1C1C1E; font-weight: 600; display: flex; align-items: center; }
        
        .calendar-card { background: #fff; border-radius: 24px; padding: 25px; border: 1px solid #E5E5EA; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        
        /* 네비게이션 레이아웃 */
        .calendar-nav { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px;
            position: relative;
        }
        
        .nav-btn { 
            background: none; 
            border: none; 
            font-size: 24px; 
            cursor: pointer; 
            color: #007AFF; 
            padding: 10px; 
            z-index: 10;
        }
        
        /* 타이틀 중앙 정렬 */
        .month-title { 
            font-size: 20px; 
            font-weight: 800; 
            white-space: nowrap; 
            position: absolute; 
            left: 50%; 
            transform: translateX(-50%);
            pointer-events: none; 
        }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; text-align: center; }
        .day-label { color: #8E8E93; font-size: 13px; font-weight: 600; margin-bottom: 10px; }
        
        .day {
            height: 45px; line-height: 45px; font-size: 16px; border-radius: 50%;
            cursor: pointer; transition: all 0.2s; position: relative; font-weight: 600;
        }
        .day:active { background: #F2F2F7; transform: scale(0.9); }
        
        .day.stamped { background-color: #34C759; color: white; box-shadow: 0 4px 10px rgba(52, 199, 89, 0.4); }
        .day.today { border: 2px solid #007AFF; box-sizing: border-box; color: #007AFF; }
        /* 오늘인데 도장 찍히면 테두리 없애고 배경색만 */
        .day.today.stamped { border: none; color: white; } 
        .day.empty { pointer-events: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/main" class="back-btn">〈 메인으로</a>
            <span style="font-weight: 700; font-size: 18px;">기록</span>
        </div>

        <div class="calendar-card">
            <div class="calendar-nav">
                <button class="nav-btn" onclick="changeMonth(-1)">〈</button>
                <span class="month-title" id="month-title"></span>
                <button class="nav-btn" onclick="changeMonth(1)">〉</button>
            </div>
            <div class="calendar-grid" id="calendar-grid">
                </div>
        </div>
        
        <p style="text-align: center; color: #8E8E93; margin-top: 20px; font-size: 14px;">
            날짜를 터치하여 기록을 추가하거나 삭제할 수 있어요.
        </p>
    </div>

    <script>
        let currentDate = new Date(); // 현재 보고 있는 달력 날짜

        // 1. 달력 로드 함수
        async function loadCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1; // 0~11 이므로 +1
            
            // 타이틀 업데이트
            document.getElementById('month-title').innerText = `${year}년 ${month}월`;
            
            const grid = document.getElementById('calendar-grid');
            
            // 요일 헤더 (일요일부터 시작)
            let htmlContent = `
                <div class="day-label" style="color:#FF3B30">일</div>
                <div class="day-label">월</div>
                <div class="day-label">화</div>
                <div class="day-label">수</div>
                <div class="day-label">목</div>
                <div class="day-label">금</div>
                <div class="day-label" style="color:#007AFF">토</div>
            `;

            try {
                // 서버에서 기록 가져오기
                const response = await fetch(`/api/get_history/${year}/${month}`);
                const history = await response.json(); // ['2026-02-05', '2026-02-08' ...]

                // 달력 계산 로직
                const firstDayIndex = new Date(year, month - 1, 1).getDay(); // 이번 달 1일의 요일 (0:일 ~ 6:토)
                const lastDate = new Date(year, month, 0).getDate(); // 이번 달 마지막 날짜
                
                // 오늘 날짜 구하기 (YYYY-MM-DD 포맷)
                const now = new Date();
                const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

                // 1. 빈 칸 채우기 (1일 전까지)
                for (let i = 0; i < firstDayIndex; i++) {
                    htmlContent += `<div class="day empty"></div>`;
                }

                // 2. 날짜 채우기
                for (let d = 1; d <= lastDate; d++) {
                    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const isStamped = history.includes(dateStr);
                    const isToday = (dateStr === todayStr);

                    // 클래스 조합
                    let classNames = "day";
                    if (isStamped) classNames += " stamped";
                    if (isToday) classNames += " today";

                    // 클릭 이벤트는 HTML 속성에 직접 넣어서 오류 방지
                    htmlContent += `<div class="${classNames}" onclick="toggleStamp('${dateStr}', this)">${d}</div>`;
                }

                grid.innerHTML = htmlContent;

            } catch (e) {
                console.error("달력 로딩 실패:", e);
                grid.innerHTML = "<p>데이터를 불러오지 못했습니다.</p>";
            }
        }

        // 2. 도장 찍기/취소 함수 (낙관적 업데이트)
        async function toggleStamp(dateStr, el) {
            // 화면 먼저 반응 (반응속도 향상)
            el.classList.toggle('stamped');
            
            // 서버 전송
            try {
                await fetch('/api/toggle_history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date: dateStr })
                });
            } catch (e) {
                console.error("기록 실패", e);
                // 실패 시 롤백 (선택사항)
                el.classList.toggle('stamped');
            }
        }

        // 3. 월 이동 함수
        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            loadCalendar();
        }

        // 4. 접속 유지 (하트비트) - 페이지 열려있는 동안 계속 전송
        function sendHeartbeat() {
            if(navigator.sendBeacon) {
                const data = JSON.stringify({ status: 1 }); // 1: 접속 중
                const blob = new Blob([data], {type: 'application/json'});
                navigator.sendBeacon("/update_status", blob);
            } else {
                fetch('/update_status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 1 }) 
                });
            }
        }

        // 초기 실행 및 3초 주기 반복
        loadCalendar();
        sendHeartbeat();
        setInterval(sendHeartbeat, 3000);

        // 페이지 닫거나 숨길 때 오프라인 처리
        window.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                const data = JSON.stringify({ status: 0 });
                const blob = new Blob([data], {type: 'application/json'});
                navigator.sendBeacon('/update_status', blob);
            } else {
                // 다시 돌아오면 접속 중으로 변경
                sendHeartbeat();
            }
        });
    </script>
</body>
</html>