<script id="exercises-data" type="application/json">
        {{ exercises|tojson|safe }}
    </script>
    <input type="hidden" id="is-hj" value="{{ 1 if routine.is_hj_mode else 0 }}">

    <script>
        // [수정] 안전하게 데이터를 읽어오는 방식
        const rawDataElement = document.getElementById("exercises-data");
        const rawData = JSON.parse(rawDataElement.textContent);
        const exercises = rawData; 
        const isHjMode = document.getElementById("is-hj").value == "1";

        let playList = []; 

        // 데이터가 잘 로드되었는지 확인하는 안전장치
        if (!exercises || exercises.length === 0) {
            console.error("운동 데이터가 비어있습니다.");
        }

        if (isHjMode) {
            document.getElementById("hj-mode-banner").style.display = "block";
            let maxSets = 0;
            exercises.forEach((ex) => (maxSets = Math.max(maxSets, ex.sets)));

            for (let s = 1; s <= maxSets; s++) {
                exercises.forEach((ex) => {
                    if (s <= ex.sets) {
                        playList.push({ ...ex, currentSet: s, totalSets: ex.sets });
                    }
                });
            }
        } else {
            exercises.forEach((ex) => {
                for (let s = 1; s <= ex.sets; s++) {
                    playList.push({ ...ex, currentSet: s, totalSets: ex.sets });
                }
            });
        }

        // ... (이하 로직 동일하지만, 변수명 충돌 방지를 위해 currentIndex 등 확인) ...
        let currentIndex = 0;
        let timerInterval = null;
        let timeLeft = 0;
        let totalTime = 0;
        let isPaused = false;
        const CIRCUMFERENCE = 691;

        window.onload = function () {
            if (playList.length > 0) {
                document.getElementById("next-ex-name-prep").innerText = playList[0].name;
                startPrep();
            } else {
                alert("수행할 운동이 없습니다. 루틴에 운동을 추가해주세요!");
                location.href = "/main";
            }
        };

        // ... (나머지 startPrep, showWorkout 등의 함수는 기획자님 코드 그대로 사용) ...
        function updateRing(id, current, total) {
            const circle = document.getElementById(id);
            const offset = CIRCUMFERENCE - (current / total) * CIRCUMFERENCE;
            circle.style.strokeDashoffset = offset;
        }

        function startPrep() {
            clearInterval(timerInterval);
            document.getElementById("prep-area").classList.remove("hidden");
            document.getElementById("workout-area").classList.add("hidden");
            document.getElementById("timer-area").classList.add("hidden");

            let prepTime = 10;
            timeLeft = prepTime;
            updateRing("prep-bar", timeLeft, prepTime);

            timerInterval = setInterval(() => {
                timeLeft -= 0.1;
                document.getElementById("prep-count").innerText = Math.ceil(timeLeft);
                updateRing("prep-bar", timeLeft, prepTime);

                if (timeLeft <= 0) {
                    skipPrep();
                }
            }, 100);
        }

        function skipPrep() {
            clearInterval(timerInterval);
            showWorkout();
        }

        function showWorkout() {
            document.getElementById("prep-area").classList.add("hidden");
            document.getElementById("timer-area").classList.add("hidden");
            document.getElementById("workout-area").classList.remove("hidden");

            const currentItem = playList[currentIndex];
            document.getElementById("ex-name").innerText = currentItem.name;
            document.getElementById("set-info").innerText = `${currentItem.currentSet} / ${currentItem.totalSets} SET`;
            document.getElementById("reps-info").innerText = `${currentItem.reps}회 수행`;

            const btn = document.getElementById("done-btn");
            if (currentIndex >= playList.length - 1) {
                btn.innerText = "운동 종료 (결과 저장)";
                btn.style.backgroundColor = "#5856D6";
            } else {
                btn.innerText = "수행 완료";
                btn.style.backgroundColor = "#34C759";
            }
        }

        function finishSet() {
            if (currentIndex >= playList.length - 1) {
                finishWorkoutSession();
                return;
            }
            const restTime = playList[currentIndex].rest_time;
            currentIndex++;
            startRest(restTime);
        }

        function startRest(duration) {
            clearInterval(timerInterval);
            document.getElementById("workout-area").classList.add("hidden");
            document.getElementById("timer-area").classList.remove("hidden");

            timeLeft = duration;
            totalTime = duration;
            isPaused = false;
            document.getElementById("pause-btn").innerText = "일시정지";
            updateRing("rest-bar", timeLeft, totalTime);
            document.getElementById("timer-count").innerText = timeLeft;

            timerInterval = setInterval(() => {
                if (!isPaused) {
                    timeLeft -= 0.1;
                    document.getElementById("timer-count").innerText = Math.ceil(timeLeft);
                    updateRing("rest-bar", timeLeft, totalTime);

                    if (timeLeft <= 0) {
                        skipRest();
                    }
                }
            }, 100);
        }

        function pauseTimer() {
            isPaused = !isPaused;
            document.getElementById("pause-btn").innerText = isPaused ? "재개" : "일시정지";
        }

        function skipRest() {
            clearInterval(timerInterval);
            showWorkout();
        }

        function finishWorkoutSession() {
            fetch("/api/record_workout_done", { method: "POST" });
            document.getElementById("workout-area").classList.add("hidden");
            document.getElementById("finish-overlay").classList.remove("hidden");
        }
    </script>