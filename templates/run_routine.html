<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>ìš´ë™ ìˆ˜í–‰ - ëŠê·¸ìš´ë™</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link rel="manifest" href="/static/manifest.json" />
    <style>
      /* 1. íƒ€ì´ë¨¸ ë° ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
      :root {
        --bg-color: #f2f2f7;
        --card-bg: #ffffff;
        --text-primary: #1c1c1e;
        --text-secondary: #8e8e93;
        --accent-color: #007aff;
        --border-color: #e5e5ea;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
        background-color: var(--bg-color);
        margin: 0;
        display: flex;
        justify-content: center;
        min-height: 100vh;
        overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
      }
      .container {
        width: 100%;
        max-width: 480px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        height: 100vh;
        padding: 20px;
        box-sizing: border-box;
      }

      /* í”„ë¡œê·¸ë ˆìŠ¤ ë§ ìŠ¤íƒ€ì¼ */
      .progress-container {
        position: relative;
        width: 240px;
        height: 240px;
        margin: 20px auto;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .progress-ring {
        position: absolute;
        top: 0;
        left: 0;
        transform: rotate(-90deg);
      }
      .progress-ring__circle {
        stroke-dasharray: 691; /* 2 * pi * 110 */
        stroke-dashoffset: 691;
        transition: stroke-dashoffset 0.1s linear;
        stroke-linecap: round;
      }
      .track {
        stroke-dashoffset: 0 !important;
        opacity: 0.3;
      }
      .timer-text {
        position: relative;
        font-size: 64px;
        font-weight: 900;
        color: var(--text-primary);
        z-index: 10;
        font-variant-numeric: tabular-nums;
      }

      /* ì¹´ë“œ ë° í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
      .workout-card {
        background: var(--card-bg);
        border-radius: 32px;
        padding: 30px 20px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: auto;
        min-height: 500px;
      }
      .workout-detail-card {
        background: var(--card-bg);
        border-radius: 32px;
        padding: 40px 20px;
        margin: 10px auto 30px auto;
        width: 100%;
        border: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        box-sizing: border-box;
      }
      .workout-category {
        font-size: 15px;
        font-weight: 700;
        color: var(--text-secondary);
        letter-spacing: 2px;
      }
      .workout-main-name {
        font-size: 42px;
        font-weight: 900;
        color: var(--text-primary);
        margin: 0;
        word-break: keep-all;
        line-height: 1.2;
      }
      .set-badge {
        background: rgba(0, 122, 255, 0.1);
        color: var(--accent-color);
        padding: 8px 24px;
        border-radius: 50px;
        font-weight: 800;
        font-size: 18px;
      }
      .reps-display {
        font-size: 36px;
        font-weight: 800;
        color: #34c759;
      }

      /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
      .btn-action {
        width: 100%;
        height: 70px;
        border-radius: 20px;
        font-size: 20px;
        font-weight: 800;
        border: none;
        cursor: pointer;
        transition: transform 0.1s;
      }
      .btn-action:active {
        transform: scale(0.98);
      }
      .btn-row {
        display: flex;
        gap: 15px;
        width: 100%;
        margin-top: 15px;
      }
      .btn-half {
        flex: 1;
      }

      #hj-mode-banner {
        background: #ff2d55;
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 700;
        margin-bottom: 20px;
        display: none;
      }
      #finish-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--card-bg);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="finish-overlay" class="hidden">
        <div style="font-size: 80px; margin-bottom: 20px">ğŸ”¥</div>
        <h1 style="font-size: 36px; font-weight: 900; margin-bottom: 15px">
          ìš´ë™ ë!!
        </h1>
        <p
          style="
            color: var(--text-secondary);
            margin-bottom: 40px;
            font-size: 18px;
            text-align: center;
          "
        >
          ì˜¤ëŠ˜ë„ í•´ë‚´ì…¨êµ°ìš”!<br />ê³ ìƒí•˜ì…¨ìŠµë‹ˆë‹¤.
        </p>
        <button
          class="btn-action"
          onclick="location.href = '/main'"
          style="background: #1c1c1e; color: white; width: 250px"
        >
          í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </button>
      </div>

      <div class="workout-card">
        <div id="hj-mode-banner">ì´íš¨ì¬ ëª¨ë“œ í™œì„±í™”: 1ì„¸íŠ¸ì”© ìˆœí™˜ ğŸ”¥</div>

        <div id="prep-area">
          <p
            style="
              font-size: 22px;
              color: #ff9500;
              font-weight: 800;
              margin-bottom: 10px;
            "
          >
            ê³§ ìš´ë™ì´ ì‹œì‘ë©ë‹ˆë‹¤!
          </p>
          <div class="progress-container">
            <svg class="progress-ring" width="240" height="240">
              <circle
                class="progress-ring__circle track"
                stroke="var(--border-color)"
                stroke-width="14"
                fill="transparent"
                r="110"
                cx="120"
                cy="120"
              />
              <circle
                id="prep-bar"
                class="progress-ring__circle"
                stroke="#FF9500"
                stroke-width="14"
                fill="transparent"
                r="110"
                cx="120"
                cy="120"
              />
            </svg>
            <div class="timer-text" id="prep-count">10</div>
          </div>
          <h2
            id="next-ex-name-prep"
            style="font-size: 30px; font-weight: 900; margin-top: 15px"
          >
            ì¤€ë¹„í•˜ì„¸ìš”
          </h2>
          <button
            class="btn-action"
            onclick="skipPrep()"
            style="
              background: var(--border-color);
              color: var(--text-primary);
              margin-top: 30px;
            "
          >
            ë°”ë¡œ ì‹œì‘
          </button>
        </div>

        <div id="workout-area" class="hidden">
          <div class="workout-detail-card">
            <p class="workout-category">{{ routine.routine_name }}</p>
            <h1 id="ex-name" class="workout-main-name">ìš´ë™ ì´ë¦„</h1>
            <div class="set-badge"><span id="set-info">1 / 1 SET</span></div>
            <div class="reps-display" id="reps-info">0íšŒ ìˆ˜í–‰</div>
          </div>
          <button
            onclick="finishSet()"
            id="done-btn"
            class="btn-action"
            style="background-color: #34c759; color: white"
          >
            ìˆ˜í–‰ ì™„ë£Œ
          </button>
        </div>

        <div id="timer-area" class="hidden">
          <p
            style="
              color: var(--text-secondary);
              font-weight: 800;
              font-size: 18px;
            "
          >
            íœ´ì‹ ì¤‘
          </p>
          <div class="progress-container">
            <svg class="progress-ring" width="240" height="240">
              <circle
                class="progress-ring__circle track"
                stroke="var(--border-color)"
                stroke-width="14"
                fill="transparent"
                r="110"
                cx="120"
                cy="120"
              />
              <circle
                id="rest-bar"
                class="progress-ring__circle"
                stroke="#007AFF"
                stroke-width="14"
                fill="transparent"
                r="110"
                cx="120"
                cy="120"
              />
            </svg>
            <div class="timer-text" id="timer-count">00</div>
          </div>
          <div class="btn-row">
            <button
              onclick="pauseTimer()"
              id="pause-btn"
              class="btn-action btn-half"
              style="
                background: var(--border-color);
                color: var(--text-primary);
              "
            >
              ì¼ì‹œì •ì§€
            </button>
            <button
              onclick="skipRest()"
              class="btn-action btn-half"
              style="background: #007aff; color: white"
            >
              ê±´ë„ˆë›°ê¸°
            </button>
          </div>
        </div>

        <a
          href="/main"
          onclick="return confirm('ìš´ë™ì„ ì¤‘ë‹¨í•˜ê³  ë‚˜ê°ˆê¹Œìš”?');"
          style="
            display: block;
            margin-top: 30px;
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 600;
          "
          >ê·¸ë§Œí• ë˜ìš”</a
        >
      </div>
    </div>

    <input type="hidden" id="ex-data" value="{{ exercises|tojson|safe }}" />
    <input
      type="hidden"
      id="is-hj"
      value="{{ 1 if routine.is_hj_mode else 0 }}"
    />

    <script>
      // [í•µì‹¬ ë¡œì§] ë°ì´í„°ë¥¼ ë¯¸ë¦¬ 'í‰íƒ„í™”(Flatten)'í•´ì„œ ì¬ìƒ ëª©ë¡ì„ ë§Œë“­ë‹ˆë‹¤.
      const rawData = JSON.parse(document.getElementById("ex-data").value);
      const isHjMode = document.getElementById("is-hj").value == "1";

      let playList = []; // ì—¬ê¸°ì— ìš´ë™ ìˆœì„œë¥¼ ì«™ í¼ì¹©ë‹ˆë‹¤.

      if (isHjMode) {
        document.getElementById("hj-mode-banner").style.display = "block";
        // ì´íš¨ì¬ ëª¨ë“œ: 1ì„¸íŠ¸ì”© ìˆœí™˜ (ìµœëŒ€ ì„¸íŠ¸ ìˆ˜ë§Œí¼ ë°˜ë³µ)
        let maxSets = 0;
        rawData.forEach((ex) => (maxSets = Math.max(maxSets, ex.sets)));

        for (let s = 1; s <= maxSets; s++) {
          rawData.forEach((ex) => {
            if (s <= ex.sets) {
              playList.push({ ...ex, currentSet: s, totalSets: ex.sets });
            }
          });
        }
      } else {
        // ì¼ë°˜ ëª¨ë“œ: í•œ ìš´ë™ ëë‚´ê³  ë‹¤ìŒ ìš´ë™
        rawData.forEach((ex) => {
          for (let s = 1; s <= ex.sets; s++) {
            playList.push({ ...ex, currentSet: s, totalSets: ex.sets });
          }
        });
      }

      let currentIndex = 0;
      let timerInterval = null;
      let timeLeft = 0;
      let totalTime = 0;
      let isPaused = false;
      const CIRCUMFERENCE = 691;

      // ì‹œì‘ ì§„ì…ì 
      window.onload = function () {
        if (playList.length > 0) {
          document.getElementById("next-ex-name-prep").innerText =
            playList[0].name;
          startPrep();
        } else {
          alert("ìš´ë™ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
          location.href = "/main";
        }
      };

      // --- ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ ---

      function updateRing(id, current, total) {
        const circle = document.getElementById(id);
        const offset = CIRCUMFERENCE - (current / total) * CIRCUMFERENCE;
        circle.style.strokeDashoffset = offset;
      }

      // 1. ì¤€ë¹„ íƒ€ì´ë¨¸
      function startPrep() {
        clearInterval(timerInterval);
        document.getElementById("prep-area").classList.remove("hidden");
        document.getElementById("workout-area").classList.add("hidden");
        document.getElementById("timer-area").classList.add("hidden");

        let prepTime = 10;
        timeLeft = prepTime;
        updateRing("prep-bar", timeLeft, prepTime);

        timerInterval = setInterval(() => {
          timeLeft -= 0.1; // ë¶€ë“œëŸ¬ìš´ ê°ì†Œ
          document.getElementById("prep-count").innerText = Math.ceil(timeLeft);
          updateRing("prep-bar", timeLeft, prepTime);

          if (timeLeft <= 0) {
            skipPrep();
          }
        }, 100);
      }

      function skipPrep() {
        clearInterval(timerInterval);
        showWorkout();
      }

      // 2. ìš´ë™ í™”ë©´ í‘œì‹œ
      function showWorkout() {
        document.getElementById("prep-area").classList.add("hidden");
        document.getElementById("timer-area").classList.add("hidden");
        document.getElementById("workout-area").classList.remove("hidden");

        const currentItem = playList[currentIndex];
        document.getElementById("ex-name").innerText = currentItem.name;
        document.getElementById("set-info").innerText =
          `${currentItem.currentSet} / ${currentItem.totalSets} SET`;
        document.getElementById("reps-info").innerText =
          `${currentItem.reps}íšŒ ìˆ˜í–‰`;

        // ë§ˆì§€ë§‰ ìš´ë™ì¸ì§€ í™•ì¸
        const btn = document.getElementById("done-btn");
        if (currentIndex >= playList.length - 1) {
          btn.innerText = "ìš´ë™ ì¢…ë£Œ (ê²°ê³¼ ì €ì¥)";
          btn.style.backgroundColor = "#5856D6";
        } else {
          btn.innerText = "ìˆ˜í–‰ ì™„ë£Œ";
          btn.style.backgroundColor = "#34C759";
        }
      }

      // 3. ì„¸íŠ¸ ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ
      function finishSet() {
        // ë§ˆì§€ë§‰ ìš´ë™ì´ë©´ ì¢…ë£Œ
        if (currentIndex >= playList.length - 1) {
          finishWorkoutSession();
          return;
        }

        // íœ´ì‹ ì‹œì‘ (ë‹¤ìŒ ìš´ë™ìœ¼ë¡œ ì¸ë±ìŠ¤ ì´ë™)
        const restTime = playList[currentIndex].rest_time;
        currentIndex++;
        startRest(restTime);
      }

      // 4. íœ´ì‹ íƒ€ì´ë¨¸
      function startRest(duration) {
        clearInterval(timerInterval);
        document.getElementById("workout-area").classList.add("hidden");
        document.getElementById("timer-area").classList.remove("hidden");

        timeLeft = duration;
        totalTime = duration;
        isPaused = false;
        document.getElementById("pause-btn").innerText = "ì¼ì‹œì •ì§€";
        updateRing("rest-bar", timeLeft, totalTime);
        document.getElementById("timer-count").innerText = timeLeft;

        timerInterval = setInterval(() => {
          if (!isPaused) {
            timeLeft -= 0.1;
            document.getElementById("timer-count").innerText =
              Math.ceil(timeLeft);
            updateRing("rest-bar", timeLeft, totalTime);

            if (timeLeft <= 0) {
              skipRest();
            }
          }
        }, 100);
      }

      function pauseTimer() {
        isPaused = !isPaused;
        document.getElementById("pause-btn").innerText = isPaused
          ? "ì¬ê°œ"
          : "ì¼ì‹œì •ì§€";
      }

      function skipRest() {
        clearInterval(timerInterval);
        showWorkout();
      }

      // 5. ìµœì¢… ì¢…ë£Œ
      function finishWorkoutSession() {
        // ì„œë²„ì— ì™„ë£Œ ê¸°ë¡ ì „ì†¡
        fetch("/api/record_workout_done", { method: "POST" });

        document.getElementById("workout-area").classList.add("hidden");
        document.getElementById("finish-overlay").classList.remove("hidden");
      }
    </script>
  </body>
</html>
