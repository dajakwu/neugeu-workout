<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìš´ë™ ìˆ˜í–‰ - ëŠê·¸ìš´ë™</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="manifest" href="/static/manifest.json">
    <style>
        :root {
            --bg-color: #f2f2f7;
            --card-bg: #ffffff;
            --text-primary: #1c1c1e;
            --text-secondary: #8e8e93;
            --accent-color: #007aff;
            --border-color: #e5e5ea;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }
        .container {
            width: 100%;
            max-width: 500px; /* ë„ˆë¬´ ë„“ì–´ì§€ëŠ” ê²ƒ ë°©ì§€ */
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .progress-container {
            position: relative;
            width: 240px;
            height: 240px;
            margin: 30px auto; /* ìœ„ì•„ë˜ ì—¬ë°± í™•ë³´ */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .progress-ring {
            position: absolute;
            top: 0; left: 0;
            transform: rotate(-90deg);
        }
        .progress-ring__circle {
            stroke-dasharray: 691;
            stroke-dashoffset: 691;
            transition: stroke-dashoffset 0.1s linear;
            stroke-linecap: round;
        }
        .track {
            stroke-dashoffset: 0 !important;
            opacity: 0.3;
        }
        .timer-text {
            position: relative;
            font-size: 64px;
            font-weight: 900;
            color: var(--text-primary);
            z-index: 10;
            font-variant-numeric: tabular-nums;
        }
        .workout-card {
            background: var(--card-bg);
            border-radius: 32px;
            padding: 30px 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: auto;
            min-height: 550px; /* ì¹´ë“œ ìµœì†Œ ë†’ì´ í™•ë³´ */
            width: 100%;
            box-sizing: border-box;
        }
        .workout-detail-card {
            background: #F9F9F9; /* ì‚´ì§ ë‹¤ë¥¸ ë°°ê²½ìƒ‰ìœ¼ë¡œ êµ¬ë¶„ */
            border-radius: 24px;
            padding: 30px 20px;
            margin: 20px auto 40px auto;
            width: 100%;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            box-sizing: border-box;
        }
        .workout-category { font-size: 14px; font-weight: 700; color: var(--text-secondary); letter-spacing: 1px; text-transform: uppercase; }
        .workout-main-name { font-size: 36px; font-weight: 900; color: var(--text-primary); margin: 0; word-break: keep-all; line-height: 1.3; }
        .set-badge { background: rgba(0, 122, 255, 0.1); color: var(--accent-color); padding: 6px 16px; border-radius: 50px; font-weight: 700; font-size: 14px; }
        .reps-display { font-size: 42px; font-weight: 800; color: #34c759; margin-top: 10px; }
        
        .btn-action { width: 100%; height: 60px; border-radius: 18px; font-size: 18px; font-weight: 700; border: none; cursor: pointer; transition: transform 0.1s; }
        .btn-action:active { transform: scale(0.98); }
        .btn-row { display: flex; gap: 15px; width: 100%; margin-top: 20px; }
        .btn-half { flex: 1; }
        
        #hj-mode-banner { background: #ff2d55; color: white; padding: 10px 20px; border-radius: 20px; font-size: 13px; font-weight: 700; margin-bottom: 20px; display: none; }
        #finish-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--card-bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <div id="finish-overlay" class="hidden">
            <div style="font-size: 80px; margin-bottom: 20px">ğŸ”¥</div>
            <h1 style="font-size: 32px; font-weight: 900; margin-bottom: 10px; color: var(--text-primary);">ìš´ë™ ë!!</h1>
            <p style="color: var(--text-secondary); margin-bottom: 40px; font-size: 16px; text-align: center; line-height: 1.5;">ì˜¤ëŠ˜ë„ í•´ë‚´ì…¨êµ°ìš”!<br />ì •ë§ ê³ ìƒí•˜ì…¨ìŠµë‹ˆë‹¤.</p>
            <button class="btn-action" onclick="location.href = '/main'" style="background: #1c1c1e; color: white; width: 100%; max-width: 300px;">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>

        <div class="workout-card">
            <div id="hj-mode-banner">ì´íš¨ì¬ ëª¨ë“œ í™œì„±í™”: 1ì„¸íŠ¸ì”© ìˆœí™˜ ğŸ”¥</div>

            <div id="prep-area" style="width: 100%;">
                <p style="font-size: 20px; color: #ff9500; font-weight: 800; margin-bottom: 10px;">ê³§ ìš´ë™ì´ ì‹œì‘ë©ë‹ˆë‹¤!</p>
                <div class="progress-container">
                    <svg class="progress-ring" width="240" height="240">
                        <circle class="progress-ring__circle track" stroke="var(--border-color)" stroke-width="14" fill="transparent" r="110" cx="120" cy="120"/>
                        <circle id="prep-bar" class="progress-ring__circle" stroke="#FF9500" stroke-width="14" fill="transparent" r="110" cx="120" cy="120"/>
                    </svg>
                    <div class="timer-text" id="prep-count">10</div>
                </div>
                <h2 id="next-ex-name-prep" style="font-size: 26px; font-weight: 800; margin-top: 15px; color: var(--text-primary);">ì¤€ë¹„í•˜ì„¸ìš”</h2>
                <button class="btn-action" onclick="skipPrep()" style="background: var(--border-color); color: var(--text-primary); margin-top: 30px;">ë°”ë¡œ ì‹œì‘</button>
            </div>

            <div id="workout-area" class="hidden" style="width: 100%;">
                <div class="workout-detail-card">
                    <p class="workout-category">{{ routine.routine_name }}</p>
                    <h1 id="ex-name" class="workout-main-name">ìš´ë™ ì´ë¦„</h1>
                    <div class="set-badge"><span id="set-info">1 / 1 SET</span></div>
                    <div class="reps-display" id="reps-info">0íšŒ ìˆ˜í–‰</div>
                </div>
                <button onclick="finishSet()" id="done-btn" class="btn-action" style="background-color: #34c759; color: white;">ìˆ˜í–‰ ì™„ë£Œ</button>
            </div>

            <div id="timer-area" class="hidden" style="width: 100%;">
                <p style="color: var(--text-secondary); font-weight: 800; font-size: 18px;">íœ´ì‹ ì¤‘</p>
                <div class="progress-container">
                    <svg class="progress-ring" width="240" height="240">
                        <circle class="progress-ring__circle track" stroke="var(--border-color)" stroke-width="14" fill="transparent" r="110" cx="120" cy="120"/>
                        <circle id="rest-bar" class="progress-ring__circle" stroke="#007AFF" stroke-width="14" fill="transparent" r="110" cx="120" cy="120"/>
                    </svg>
                    <div class="timer-text" id="timer-count">00</div>
                </div>
                <div class="btn-row">
                    <button onclick="pauseTimer()" id="pause-btn" class="btn-action btn-half" style="background: var(--border-color); color: var(--text-primary);">ì¼ì‹œì •ì§€</button>
                    <button onclick="skipRest()" class="btn-action btn-half" style="background: #007aff; color: white">ê±´ë„ˆë›°ê¸°</button>
                </div>
            </div>

            <a href="/main" onclick="return confirm('ìš´ë™ì„ ì¤‘ë‹¨í•˜ê³  ë‚˜ê°ˆê¹Œìš”?');" style="display: block; margin-top: 30px; color: var(--text-secondary); text-decoration: none; font-weight: 600; font-size: 14px;">ê·¸ë§Œí• ë˜ìš”</a>
        </div>
    </div>

    <script id="exercises-data" type="application/json">{{ exercises|tojson|safe }}</script>
    <input type="hidden" id="is-hj" value="{{ 1 if routine.is_hj_mode else 0 }}">

    <script>
        // 1. ë°ì´í„° ë° ì´ˆê¸° ë³€ìˆ˜ ë¡œë“œ
        const dataElement = document.getElementById("exercises-data");
        const exercises = JSON.parse(dataElement.textContent);
        const isHjMode = document.getElementById("is-hj").value == "1";
        
        // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;

        let playList = [];
        let currentIndex = 0;
        let timerInterval = null;
        let timeLeft = 0;
        let totalTime = 0;
        let isPaused = false;
        let lastSecond = 0; 
        const CIRCUMFERENCE = 691;

        // ì‚¬ìš´ë“œ í•¨ìˆ˜
        function playBeep(freq, duration, volume = 1.0) {
            try {
                if (!audioCtx) audioCtx = new AudioContext();
                if (audioCtx.state === 'suspended') audioCtx.resume();

                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();

                osc.type = "sine";
                osc.frequency.value = freq;
                
                gain.gain.setValueAtTime(volume, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);

                osc.connect(gain);
                gain.connect(audioCtx.destination);

                osc.start();
                osc.stop(audioCtx.currentTime + duration);
            } catch (e) { console.log(e); }
        }

        // ìƒíƒœ ì „ì†¡ í•¨ìˆ˜
        function sendStatus(status) {
            if(navigator.sendBeacon) {
                const data = JSON.stringify({ status: status });
                const blob = new Blob([data], {type: 'application/json'});
                navigator.sendBeacon("/update_status", blob);
            } else {
                fetch("/update_status", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ status: status }),
                    keepalive: true
                });
            }
        }

        // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìƒì„±
        if (isHjMode) {
            document.getElementById("hj-mode-banner").style.display = "block";
            let maxSets = 0;
            exercises.forEach(ex => maxSets = Math.max(maxSets, ex.sets));
            for (let s = 1; s <= maxSets; s++) {
                exercises.forEach(ex => {
                    if (s <= ex.sets) playList.push({ ...ex, currentSet: s, totalSets: ex.sets });
                });
            }
        } else {
            exercises.forEach(ex => {
                for (let s = 1; s <= ex.sets; s++) playList.push({ ...ex, currentSet: s, totalSets: ex.sets });
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            if (playList.length > 0) {
                document.getElementById("next-ex-name-prep").innerText = playList[0].name;
                startPrep();
            } else {
                alert("ìš´ë™ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                location.href = "/main";
            }
            sendStatus(2);
            setInterval(() => sendStatus(2), 3000);
        };

        function updateRing(id, current, total) {
            const circle = document.getElementById(id);
            if (!circle) return;
            const offset = CIRCUMFERENCE - (current / total) * CIRCUMFERENCE;
            circle.style.strokeDashoffset = offset;
        }

        // ì¤€ë¹„ ë‹¨ê³„
        function startPrep() {
            clearInterval(timerInterval);
            document.getElementById("prep-area").classList.remove("hidden");
            document.getElementById("workout-area").classList.add("hidden");
            document.getElementById("timer-area").classList.add("hidden");
            
            let prepTime = 10;
            timeLeft = prepTime;
            lastSecond = Math.ceil(timeLeft);
            updateRing("prep-bar", timeLeft, prepTime);
            
            timerInterval = setInterval(() => {
                timeLeft -= 0.1;
                const displayTime = Math.ceil(timeLeft);
                document.getElementById("prep-count").innerText = displayTime;
                updateRing("prep-bar", timeLeft, prepTime);
                
                if (displayTime < lastSecond) {
                    playBeep(800, 0.05, 0.3); 
                    lastSecond = displayTime;
                }
                if (Math.abs(timeLeft - Math.floor(timeLeft)) < 0.05 && displayTime <= 3 && displayTime > 0) {
                    playBeep(440, 0.1, 0.5);
                }
                if (timeLeft <= 0) {
                    playBeep(1200, 0.4, 1.0);
                    skipPrep();
                }
            }, 100);
        }

        function skipPrep() {
            if (!audioCtx) audioCtx = new AudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            clearInterval(timerInterval);
            showWorkout();
        }

        // ìš´ë™ í™”ë©´
        function showWorkout() {
            document.getElementById("prep-area").classList.add("hidden");
            document.getElementById("timer-area").classList.add("hidden");
            document.getElementById("workout-area").classList.remove("hidden");
            
            const cur = playList[currentIndex];
            document.getElementById("ex-name").innerText = cur.name;
            document.getElementById("set-info").innerText = `${cur.currentSet} / ${cur.totalSets} SET`;
            document.getElementById("reps-info").innerText = `${cur.reps}íšŒ ìˆ˜í–‰`;
            
            sendStatus(2);

            const btn = document.getElementById("done-btn");
            if (currentIndex >= playList.length - 1) {
                btn.innerText = "ìš´ë™ ì¢…ë£Œ (ê²°ê³¼ ì €ì¥)";
                btn.style.backgroundColor = "#5856D6";
            } else {
                btn.innerText = "ìˆ˜í–‰ ì™„ë£Œ";
                btn.style.backgroundColor = "#34C759";
            }
        }

        function finishSet() {
            playBeep(600, 0.1, 0.5);
            if (currentIndex >= playList.length - 1) {
                finishWorkoutSession();
                return;
            }
            const restTime = playList[currentIndex].rest_time;
            currentIndex++;
            startRest(restTime);
        }

        // íœ´ì‹ íƒ€ì´ë¨¸
        function startRest(duration) {
            clearInterval(timerInterval);
            document.getElementById("workout-area").classList.add("hidden");
            document.getElementById("timer-area").classList.remove("hidden");
            
            timeLeft = duration;
            totalTime = duration;
            lastSecond = Math.ceil(timeLeft);
            isPaused = false;
            document.getElementById("pause-btn").innerText = "ì¼ì‹œì •ì§€";
            document.getElementById("timer-count").innerText = timeLeft;
            updateRing("rest-bar", timeLeft, totalTime);
            
            timerInterval = setInterval(() => {
                if (!isPaused) {
                    timeLeft -= 0.1;
                    const displayTime = Math.ceil(timeLeft);
                    document.getElementById("timer-count").innerText = displayTime;
                    updateRing("rest-bar", timeLeft, totalTime);

                    if (displayTime < lastSecond) {
                        playBeep(800, 0.05, 0.3);
                        lastSecond = displayTime;
                    }
                    if (Math.abs(timeLeft - Math.floor(timeLeft)) < 0.05 && displayTime <= 3 && displayTime > 0) {
                        playBeep(440, 0.1, 0.8);
                    }
                    if (timeLeft <= 0) {
                        playBeep(1500, 0.6, 1.0);
                        skipRest();
                    }
                }
            }, 100);
        }

        function pauseTimer() {
            isPaused = !isPaused;
            document.getElementById("pause-btn").innerText = isPaused ? "ì¬ê°œ" : "ì¼ì‹œì •ì§€";
            if (!isPaused && audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        }

        function skipRest() {
            clearInterval(timerInterval);
            showWorkout();
        }

        function finishWorkoutSession() {
            playBeep(1000, 0.5, 1.0);
            sendStatus(1);
            fetch("/api/record_workout_done", { method: "POST" });
            document.getElementById("workout-area").classList.add("hidden");
            document.getElementById("finish-overlay").classList.remove("hidden");
        }
        
        window.addEventListener("beforeunload", () => {
             sendStatus(0);
        });
    </script>
</body>
</html>