<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëŠê·¸ìš´ë™</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* [ë””ìì¸ ê¸´ê¸‰ ìˆ˜ì •] ë¶ˆí•„ìš”í•œ ì—¬ë°± ì œê±° ë° ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ì ìš© */
        .friend-card {
            background: #ffffff;
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            width: 100%;
            box-sizing: border-box; /* íŒ¨ë”© í¬í•¨ í¬ê¸° ê³„ì‚° */
        }

        .friend-list {
            display: flex;
            flex-direction: column;
            gap: 15px; /* ì•„ì´í…œ ê°„ê²© */
        }

        .friend-item {
            display: flex;
            align-items: center;
            width: 100%;
            padding-bottom: 12px;
            border-bottom: 1px solid #F2F2F7;
        }

        .friend-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .profile-img-box {
            position: relative;
            width: 52px;
            height: 52px;
            margin-right: 15px; /* ì‚¬ì§„ê³¼ ê¸€ì ì‚¬ì´ ê°„ê²© ì¢í˜ */
            flex-shrink: 0;
        }
        
        .profile-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .friend-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .friend-name {
            font-size: 17px;
            font-weight: 700;
            color: #1c1c1e;
            margin-bottom: 3px;
        }

        .status-text {
            font-size: 13px;
            font-weight: 500;
        }

        /* ìƒíƒœë³„ í…ìŠ¤íŠ¸ ì»¬ëŸ¬ */
        .status-online { color: #34C759; font-weight: 700; } /* ì´ˆë¡ */
        .status-workout { color: #FF2D55; font-weight: 800; } /* ë¹¨ê°• */
        .status-offline { color: #8E8E93; } /* íšŒìƒ‰ */
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px;">
            <h1 style="font-size: 28px; font-weight: 900; margin: 0;">ğŸ”¥ ëŠê·¸ìš´ë™</h1>
            <div style="display: flex; gap: 15px;">
                <a href="/calendar" style="font-size: 24px; text-decoration: none;">ğŸ“…</a>
                <a href="/profile" style="font-size: 24px; text-decoration: none;">ğŸ‘¤</a>
            </div>
        </div>

        <h2 style="font-size: 20px; font-weight: 800; margin-bottom: 15px; color: #1c1c1e;">ë‚´ ë£¨í‹´</h2>
        <div class="routine-list">
            {% for routine in routines %}
            <div class="routine-card" onclick="location.href='/run_routine/{{ routine.id }}'">
                <div class="routine-info">
                    <span class="routine-name">{{ routine.routine_name }}</span>
                    {% if routine.is_hj_mode %}
                    <span style="font-size: 12px; background: #FF2D55; color: white; padding: 2px 8px; border-radius: 10px; margin-left: 5px;">HJëª¨ë“œ</span>
                    {% endif %}
                </div>
                <div class="routine-actions">
                    <button class="btn-icon edit" onclick="event.stopPropagation(); location.href='/edit_routine/{{ routine.id }}'">âš™ï¸</button>
                    <button class="btn-icon delete" onclick="event.stopPropagation(); if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) location.href='/delete_routine/{{ routine.id }}'">ğŸ—‘ï¸</button>
                </div>
            </div>
            {% endfor %}
            <button class="btn-add" onclick="document.getElementById('add-modal').style.display='flex'">+ ìƒˆ ë£¨í‹´ ë§Œë“¤ê¸°</button>
        </div>

        <div style="height: 40px;"></div>

        <h2 style="font-size: 20px; font-weight: 800; margin-bottom: 15px; color: #1c1c1e;">ì¹œêµ¬ë“¤ì˜ ìƒíƒœ</h2>
        <div class="friend-card">
            <div id="friend-list-container" class="friend-list">
                <div style="text-align: center; padding: 20px; color: #8e8e93;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <div id="add-modal" class="modal-overlay" style="display:none;">
        <div class="modal-box">
            <h3>ìƒˆ ë£¨í‹´ ì´ë¦„</h3>
            <form action="/add_routine" method="POST">
                <input type="text" name="routine_name" placeholder="ì˜ˆ: ê°€ìŠ´/ì‚¼ë‘ ë°•ì‚´" required autofocus>
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="document.getElementById('add-modal').style.display='none'">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-confirm">ìƒì„±</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-container" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; max-width: 350px;"></div>

    <script>
        // 1. [ê¸°ëŠ¥ ìˆ˜ì •] ê°•ë ¥í•œ ì ‘ì† ì‹ í˜¸ ì „ì†¡ (Fetch ì‚¬ìš©)
        function sendHeartbeat() {
            fetch('/update_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 1 }) 
            }).catch(err => console.log('ì ‘ì† ì‹ í˜¸ ì‹¤íŒ¨:', err));
        }

        // 2. ì¹œêµ¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° & UI ë Œë”ë§
        async function refreshFriends() {
            try {
                const response = await fetch('/get_friends_status');
                if (response.status === 401) { window.location.href = '/'; return; }
                
                const data = await response.json();
                const container = document.getElementById('friend-list-container');
                if (!data.friends) return;

                // ì •ë ¬: ìš´ë™ ì¤‘ -> ì ‘ì† ì¤‘ -> ì˜¤í”„ë¼ì¸ ìˆœì„œ
                data.friends.sort((a, b) => b.is_working_out - a.is_working_out);
                
                let newHtml = '';
                data.friends.forEach(f => {
                    const isMe = f.user_id === "{{ session.user_id }}";
                    
                    let statusText = "ì˜¤í”„ë¼ì¸";
                    let statusClass = "status-offline";
                    let statusIcon = "";

                    if (f.is_working_out === 2) {
                        statusText = "ìš´ë™ ì¤‘";
                        statusClass = "status-workout";
                        
                        // ìš´ë™ ì‹œì‘ ì•Œë¦¼
                        const key = `notified_${f.user_id}`;
                        if (!sessionStorage.getItem(key) && !isMe) {
                            showToast(`${f.nickname}ë‹˜ì´ ìš´ë™ì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤!`);
                            sessionStorage.setItem(key, 'true');
                        }
                    } else if (f.is_working_out === 1) {
                        statusText = "ì ‘ì† ì¤‘";
                        statusClass = "status-online";
                        sessionStorage.removeItem(`notified_${f.user_id}`);
                    }

                    // í”„ë¡œí•„ ì´ë¯¸ì§€ ì²˜ë¦¬
                    const imgTag = f.profile_img 
                        ? `<img src="${f.profile_img}" class="profile-img">`
                        : `<div style="width:100%; height:100%; border-radius:50%; background:#F2F2F7; display:flex; align-items:center; justify-content:center; color:#8E8E93; font-weight:700;">${f.nickname[0]}</div>`;

                    newHtml += `
                        <div class="friend-item">
                            <div class="profile-img-box">
                                ${imgTag}
                            </div>
                            <div class="friend-info">
                                <span class="friend-name">${f.nickname} ${isMe ? '<span style="font-size:12px; color:#007AFF; font-weight:400;">(ë‚˜)</span>' : ''}</span>
                                <span class="status-text ${statusClass}">${statusText}</span>
                            </div>
                        </div>`;
                });
                container.innerHTML = newHtml;
            } catch (e) { console.error(e); }
        }

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.innerText = msg;
            toast.style.cssText = "background: rgba(0,0,0,0.85); color: white; padding: 12px 20px; border-radius: 25px; margin-bottom: 10px; font-weight: 600; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); animation: fadein 0.3s forwards;";
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // 3. ì‹¤í–‰ ë¡œì§
        // í˜ì´ì§€ ì¼œìë§ˆì ì¦‰ì‹œ ì‹¤í–‰
        sendHeartbeat();
        refreshFriends();

        // 3ì´ˆë§ˆë‹¤ ë°˜ë³µ (ì ‘ì† ìœ ì§€ & ì¹œêµ¬ ëª©ë¡ ê°±ì‹ )
        setInterval(() => {
            sendHeartbeat();
            refreshFriends();
        }, 3000);

        // í˜ì´ì§€ ë‚˜ê°ˆ ë•Œ ì˜¤í”„ë¼ì¸ ì²˜ë¦¬ (ë³´ì¡° ìˆ˜ë‹¨)
        window.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                navigator.sendBeacon('/update_status', JSON.stringify({ status: 0 }));
            } else {
                sendHeartbeat(); // ëŒì•„ì˜¤ë©´ ì¦‰ì‹œ ì ‘ì† ì‹ í˜¸
            }
        });
    </script>
    <style>
        @keyframes fadein { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</body>
</html>