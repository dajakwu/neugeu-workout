<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëŠê·¸ìš´ë™ - ë©”ì¸</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="manifest" href="/static/manifest.json">
    <style>
        /* ì›ë³¸ ë””ìì¸ ìœ ì§€ */
        .main-content { display: flex; flex-direction: column; gap: 20px; padding: 10px; padding-bottom: 100px; }
        
        .friend-bar {
            display: flex; overflow-x: auto; gap: 20px; padding: 15px 5px;
            background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border-color);
            -webkit-overflow-scrolling: touch; scrollbar-width: thin;
        }
        .friend-bar::-webkit-scrollbar { height: 4px; }
        .friend-bar::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }

        .profile-container { position: relative; display: inline-block; }
        .status-dot {
            position: absolute; bottom: 2px; right: 2px; width: 14px; height: 14px; border: 2px solid var(--card-bg); border-radius: 50%; display: none;
        }
        .status-dot.online { background: #007AFF; display: block; }
        .status-dot.workout { background: #34C759; display: block; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }

        .working-out-text { font-size: 10px; font-weight: 800; display: none; margin-top: 4px; }
        .working-out-text.online { display: block; color: #007AFF; }
        .working-out-text.workout { display: block; color: #34C759; }

        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; }
        .toast {
            background: rgba(28, 28, 30, 0.95); color: #fff; padding: 12px 25px; border-radius: 30px;
            font-size: 14px; font-weight: 600; margin-bottom: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            animation: slideDown 0.5s ease-out, fadeOut 0.5s 2.5s forwards; white-space: nowrap;
        }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }

        .routine-card { background: var(--card-bg); border-radius: 24px; padding: 25px; border: 1px solid var(--border-color); width: 100%; box-sizing: border-box; margin-bottom: 15px; }
        .welcome-section { padding: 10px 5px; text-align: left; position: relative; }
        .profile-edit-link { display: inline-block; margin-top: 8px; font-size: 14px; color: var(--accent-color); text-decoration: none; font-weight: 600; }

        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; z-index: 1000;
        }
        .btn-calendar {
            width: 100%; padding: 18px; background: var(--text-primary); color: var(--card-bg);
            border-radius: 20px; font-size: 16px; font-weight: 700; border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; text-align: center; display: block; text-decoration: none;
        }

        /* ë‹¤í¬ëª¨ë“œ í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .theme-toggle {
            position: absolute; top: 10px; right: 5px; background: var(--border-color);
            border: none; width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer;
        }
    </style>
</head>
<body>
<div id="toast-container"></div>
    <button class="theme-switch" onclick="toggleTheme()" id="theme-btn">ğŸŒ™</button>
    <div class="container">
        <div class="main-content">
            <div class="friend-bar" id="friend-list-container"></div>

            <div class="welcome-section">
                <h2 style="font-size: 26px; font-weight: 800; line-height: 1.3; margin: 0;">
                    <span style="color: var(--accent-color);">{{ session.nickname }}</span>ë‹˜,<br>í™˜ì˜í•©ë‹ˆë‹¤! ğŸ”¥
                </h2>
                <a href="/profile" class="profile-edit-link">ë‚´ ì •ë³´ ìˆ˜ì • ã€‰</a>
            </div>

            <div class="routine-section">
                <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 15px; margin-left: 5px;">ë‚´ ë£¨í‹´</h3>
                {% for routine in routines %}
                <div class="routine-card">
                    <span style="font-size: 20px; font-weight: 800; display: block; margin-bottom: 20px;">{{ routine.routine_name }}</span>
                    <div class="btn-group" style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="location.href='/run_routine/{{ routine.id }}'" style="height: 60px; font-size: 18px;">ìš´ë™ ì‹œì‘</button>
                        <div class="btn-sub" style="display: flex; gap: 10px;">
                            <a href="/edit_routine/{{ routine.id }}" class="edit-btn" style="flex: 1; background: var(--bg-color); color: var(--text-primary); text-align: center; line-height: 50px; text-decoration: none; border-radius: 12px; font-weight: 600; font-size: 14px; border: 1px solid var(--border-color);">ìˆ˜ì •</a>
                            
                            <form action="/delete_routine/{{ routine.id }}" method="POST" style="flex: 1;" onsubmit="return confirm('ì‚­ì œí• ê¹Œìš”?')">
                                <button type="submit" class="del-btn" style="width: 100%; background: #FFF0F0; color: #FF3B30; border-radius: 12px; font-weight: 600; border: none; height: 50px; font-size: 14px;">ì‚­ì œ</button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                {% if routines|length < 5 %}
                    <form action="/add_routine" method="POST" style="margin-top: 10px;">
                        <input type="hidden" name="routine_name" value="ìƒˆ ë£¨í‹´">
                        <button type="submit" style="background-color: var(--border-color); color: var(--text-primary); width: 100%; border: none; height: 50px; border-radius: 12px; font-weight: 600;">+ ë£¨í‹´ ì¶”ê°€</button>
                    </form>
                {% endif %}
            </div>

            <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
                {% if session.get('role') == 'admin' %}
                    <button onclick="location.href='/admin'" style="background-color: #5856D6; width: 100%; border: none; height: 50px; border-radius: 12px; color: white; font-weight: 600;">ê´€ë¦¬ì íŒ¨ë„</button>
                {% endif %}
                <a href="/logout" style="text-align: center; color: var(--text-secondary); text-decoration: none; font-size: 14px; padding: 15px;">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>
    </div>
    
    <div class="bottom-nav">
        <a href="/calendar" class="btn-calendar">ğŸ“… ìº˜ë¦°ë” / ê¸°ë¡ ë³´ê¸°</a>
    </div>

<script>
        // 1. í…Œë§ˆ ì ìš© ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            const btn = document.getElementById('theme-btn');
            if(btn) btn.innerHTML = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        }
        function toggleTheme() {
            const next = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            applyTheme(next);
        }
        applyTheme(localStorage.getItem('theme') || 'light');

        // 2. ì¹œêµ¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (í…ìŠ¤íŠ¸ ë°©ì‹ UI)
        async function refreshFriends() {
            try {
                const response = await fetch('/get_friends_status');
                if (response.status === 401) { window.location.href = '/'; return; }
                
                const data = await response.json();
                const container = document.getElementById('friend-list-container');
                if (!data.friends || !container) return;

                // ìš´ë™ ì¤‘ì¸ ì‚¬ëŒ ìš°ì„  ì •ë ¬
                data.friends.sort((a, b) => b.is_working_out - a.is_working_out);
                
                let newHtml = '';
                data.friends.forEach(f => {
                    const isMe = f.user_id === "{{ session.user_id }}";
                    
                    // [ìˆ˜ì •] ê¸°íšìë‹˜ì´ ì›í•˜ì‹œëŠ” í…ìŠ¤íŠ¸ ë°©ì‹ ìƒíƒœ í‘œì‹œ
                    let statusText = "ì˜¤í”„ë¼ì¸";
                    let statusColor = "#8E8E93"; // ê¸°ë³¸ íšŒìƒ‰ (ì˜¤í”„ë¼ì¸)
                    let fontWeight = "400";

                    if (f.is_working_out === 2) {
                        statusText = "ìš´ë™ ì¤‘ ğŸ”¥";
                        statusColor = "#FF2D55"; // ë¹¨ê°•
                        fontWeight = "800";
                        
                        // ìš´ë™ ì‹œì‘ ì•Œë¦¼ (í† ìŠ¤íŠ¸)
                        const key = `notified_${f.user_id}`;
                        if (!sessionStorage.getItem(key) && !isMe) {
                            showToast(`${f.nickname}ë‹˜ì´ ìš´ë™ì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤! ğŸ”¥`);
                            sessionStorage.setItem(key, 'true');
                        }
                    } else if (f.is_working_out === 1) {
                        statusText = "ì ‘ì† ì¤‘";
                        statusColor = "#34C759"; // ì´ˆë¡
                        fontWeight = "700";
                        sessionStorage.removeItem(`notified_${f.user_id}`);
                    }

                    // í”„ë¡œí•„ ì´ë¯¸ì§€ (í…Œë‘ë¦¬ ì—†ì´ ê¹”ë”í•˜ê²Œ)
                    const imgTag = f.profile_img 
                        ? `<img src="${f.profile_img}" style="width:48px; height:48px; border-radius:50%; object-fit:cover;">`
                        : `<div style="width:48px; height:48px; border-radius:50%; background:var(--bg-color); display:flex; align-items:center; justify-content:center; color:var(--text-secondary); font-weight:700;">${f.nickname[0]}</div>`;

                    newHtml += `
                        <div class="friend-item" style="display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color); width: 100%;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                ${imgTag}
                                <div style="display: flex; flex-direction: column; align-items: flex-start;">
                                    <span style="font-weight: 700; font-size: 16px; color: var(--text-primary);">${f.nickname}${isMe ? ' (ë‚˜)' : ''}</span>
                                    <span style="font-size: 13px; color: ${statusColor}; font-weight: ${fontWeight}; margin-top: 2px;">${statusText}</span>
                                </div>
                            </div>
                        </div>`;
                });
                container.innerHTML = newHtml;
            } catch (e) { console.error(e); }
        }

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = msg;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // 3ì´ˆë§ˆë‹¤ ì¹œêµ¬ ëª©ë¡ ê°±ì‹ 
        refreshFriends();
        setInterval(refreshFriends, 3000);
    </script>
    <style>
        .status-badge { position: absolute; bottom: 0; right: 0; font-size: 16px; background: white; border-radius: 50%; width: 20px; height: 20px; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</body>
</html>